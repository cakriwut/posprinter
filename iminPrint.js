"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,e){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)?module.exports=t.iminPrint?e(t,!0):function(t){if(!t.iminPrint)throw new Error("iminos requires a window");return e(t)}:e(t)}("undefined"!=typeof window?window:void 0,function(a,t){var e=function t(e){return new t.fn.init(e)};return((e.fn=e.prototype={constructor:e,connect:function(t){var e=this,n=a.MozWebSocket||a.WebSocket;if(n){try{this.ws=new n("ws://"+this.address+"/websocket"),this.soketEvent(t)}catch(t){e.reconnect()}return this}void 0},soketEvent:function(e){var n=this;this.ws.onclose=function(){void 0,n.reconnect(n.address),"function"==typeof e&&e(n.ws)},this.ws.onerror=function(){void 0,n.reconnect(n.address),"function"==typeof e&&e(n.ws)},a.onbeforeunload=function(t){void 0,n.ws.close()},this.ws.onopen=function(){if(void 0,"function"==typeof e&&e(n.ws),n.ws.readyState!==n.ws.OPEN)return n.reconnect(n.address);document.addEventListener("visibilitychange",function(){var t=document.visibilityState;void 0,"hidden"==t&&void 0,"visible"==t&&(void 0,IminPrintInstance.initPrinter(n.currentPrintConnectType,1))}),n.heartCheck.start(n.ws)},this.ws.onmessage=function(t){if(void 0,void 0,JSON.parse(t.data)&&JSON.parse(t.data).data&&JSON.parse(t.data).data.text&&"ping"==JSON.parse(t.data).data.text){if(void 0,n.ws.readyState!==n.ws.OPEN)return n.reconnect(n.address);n.heartCheck.start(n.ws)}else n.callback&&"function"==typeof e&&n.callback(t)}},reconnect:function(){var t=this;this.lockReconnect||(this.lockReconnect=!0,this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){t.connect(t.address),t.lockReconnect=!1},4e3))},heartCheck:{timeout:3e3,timeoutObj:null,serverTimeoutObj:null,start:function(t){var e=this;this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj),this.timeoutObj=setTimeout(function(){t.send(JSON.stringify({data:{text:"ping",value:-1},type:0})),e.serverTimeoutObj=setTimeout(function(){t.close()},e.timeout)},this.timeout)}},initPrinter:function(t,e){void 0,this.currentPrintConnectType=t,this.ws.send(JSON.stringify({data:{text:t,value:e||-1},type:1}))},getPrinterStatus:function(t,n){var i=this;this.ws.send(JSON.stringify({data:{text:t,value:-1},type:2})),this.callback=function(t){if(2==JSON.parse(t.data).type){void 0;var e=JSON.parse(t.data).data;e.text=i.PrinterStatus[e.value],n(e)}}},printAndLineFeed:function(){this.ws.send(JSON.stringify({data:{text:"",value:-1},type:3}))},printAndFeedPaper:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:255<=t?255:t},type:4}))},partialCut:function(){this.ws.send(JSON.stringify({data:{text:"",value:-1},type:5}))},setAlignment:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:2<=t?2:t},type:6}))},setTextSize:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t},type:7}))},setTextTypeface:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t},type:8}))},setTextStyle:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:3<=t?3:t},type:9}))},setTextLineSpacing:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t},type:10}))},setTextWidth:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:576<=t?576:t},type:11}))},printText:function(t,e){var n;null==e?(n={text:t,value:-1},this.ws.send(JSON.stringify({data:n,type:12}))):(n={text:0==e&&"n"==t.charAt(t.length-1)?t.slice(0,t.length-1)+"\n":t,value:e<=0?0:1<=e?1:e},this.ws.send(JSON.stringify({data:n,type:13})))},printColumnsText:function(t,e,n,i,s){var o=[];if(n&&n.length)for(var r=0;r<n.length;r++){var a=n[r];o.push(a<=0?0:2<=a?2:a)}this.ws.send(JSON.stringify({data:{colTextArr:t,colWidthArr:e,colAlign:o.length?o:n,size:i,text:"",value:s<0?0:576<s?576:s},type:14}))},setBarCodeWidth:function(t){this.ws.send(JSON.stringify({data:{text:"",value:void 0!==t?t<=2?2:6<=t?6:t:3},type:15}))},setBarCodeHeight:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=1?1:255<=t?255:t},type:16}))},setBarCodeContentPrintPos:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:3<=t?3:t},type:17}))},printBarCode:function(t,e,n){null==n?this.ws.send(JSON.stringify({data:{value:t<=0?0:6<t?73:t,text:e},type:18})):this.ws.send(JSON.stringify({data:{value:t<=0?0:6<t?73:t,text:e,alignmentMode:n<=0?0:2<=n?2:n},type:19}))},setQrCodeSize:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=1?1:9<=t?9:t},type:20}))},setQrCodeErrorCorrectionLev:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=48?48:51<=t?51:t},type:21}))},setLeftMargin:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=0?0:576<=t?576:t},type:22}))},printQrCode:function(t,e){null==e?this.ws.send(JSON.stringify({data:{text:t,value:-1},type:23})):this.ws.send(JSON.stringify({data:{text:t,value:e<=0?0:2<=e?2:e},type:24}))},setPageFormat:function(t){this.ws.send(JSON.stringify({data:{text:"",value:t<=1?1:58<=t?58:t},type:25}))},openCashBox:function(){this.ws.send(JSON.stringify({data:{text:"",value:-1},type:100}))},compressImg:function(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),s=t.width,o=t.height;return n.width=s,n.height=o,i.clearRect(0,0,s,o),i.drawImage(t,0,0,s,o),n.toDataURL(e||"image/png")},printSingleBitmap:function(n,i){var s=this;function o(t){var e;e=0<=t.split(",")[0].indexOf("base64")?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(e.length),s=0;s<e.length;s++)i[s]=e.charCodeAt(s);return new Blob([i],{type:n})}var r=new Image;r.src=n,r.onload=function(){var t=new FormData;t.append("file",o(s.compressImg(r,o(n).type)));var e=null;(e=a.XMLHttpRequest?new XMLHttpRequest:a.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):null)&&(e.open("POST","http://"+s.address+"/upload"),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(void 0,e.responseText&&(null==i?s.ws.send(JSON.stringify({data:{text:"",value:-1},type:26})):s.ws.send(JSON.stringify({data:{text:"",value:i},type:27}))),e=null)},e.send(t))}}}).init=function(t){return this.lockReconnect=!1,this.timer=0,this.address=(t||"localhost")+":8081",this.version="1.2.2",this.PrintConnectType={USB:"USB",SPI:"SPI",Bluetooth:"Bluetooth"},this.currentPrintConnectType=this.PrintConnectType.SPI,this.PrinterStatus={"-1":"The printer is not connected or powered on",0:"The printer is normal",1:"The printer is not connected or powered on",3:" Print head open",7:"No Paper Feed",8:"Paper Running Out",99:"Other errors"},this.ws,this}).prototype=e.fn,void 0===t&&(a.iminPrint=e),e});